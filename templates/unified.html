<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/chart.css">
    <style>
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--text);
            background: var(--bg-hover);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-btn .badge {
            background: var(--accent);
            color: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 8px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 60px);
        }

        .tab-content.active {
            display: block;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .page-header h1 {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* Remote Machines Panel */
        .remote-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .remote-panel h3 {
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .machine-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .machine-card {
            background: var(--bg-hover);
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .machine-card.active {
            border-left: 3px solid var(--green);
        }

        .machine-card.inactive {
            border-left: 3px solid var(--text-muted);
            opacity: 0.6;
        }

        /* Run selector */
        .run-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .run-selector select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            min-width: 300px;
        }

        /* Model List (History) */
        .model-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .model-sidebar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }

        .model-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .model-item:hover {
            background: var(--bg-hover);
        }

        .model-item.selected {
            background: var(--bg-hover);
            border-left: 3px solid var(--accent);
        }

        .model-name {
            font-weight: 600;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .model-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px 12px;
            font-size: 0.8rem;
        }

        .model-stats > div {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .model-stats > div span:last-child {
            font-family: var(--font-mono);
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        .model-detail {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .model-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Skeleton Loading Animation */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-elevated) 25%, var(--bg-card) 50%, var(--bg-elevated) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.full { width: 100%; }

        .skeleton-row {
            display: flex;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .skeleton-cell {
            height: 16px;
            flex: 1;
        }

        .skeleton-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 10px;
        }

        .skeleton-stat {
            height: 40px;
            width: 100%;
        }

        /* Fade in animation for loaded content */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn {{ 'active' if active_tab == 'hub' else '' }}" onclick="switchTab('hub')">
            Hub
        </button>
        <button class="tab-btn {{ 'active' if active_tab == 'live' else '' }}" onclick="switchTab('live')">
            Live Trading
        </button>
        <button class="tab-btn {{ 'active' if active_tab == 'training' else '' }}" onclick="switchTab('training')">
            Training <span class="badge" id="active-runs-badge">0</span>
        </button>
        <button class="tab-btn {{ 'active' if active_tab == 'history' else '' }}" onclick="switchTab('history')">
            History
        </button>
        <div style="flex: 1;"></div>
        <span id="clock" style="padding: 15px; color: var(--text-muted); font-family: monospace;"></span>
    </nav>

    <!-- Hub Tab -->
    <div id="tab-hub" class="tab-content {{ 'active' if active_tab == 'hub' else '' }}">
        <div class="page-header">
            <h1>Dashboard Hub</h1>
            <div class="header-actions">
                <button class="btn" onclick="refreshHub()">Refresh</button>
            </div>
        </div>

        <!-- Remote Machines -->
        <div class="remote-panel">
            <h3>Connected Machines</h3>
            <div class="machine-list" id="machine-list">
                <div class="machine-card active">
                    <strong>Local</strong><br>
                    <span class="muted">This machine</span>
                </div>
            </div>
        </div>

        <!-- Scoreboard -->
        <div class="card">
            <h3>Experiment Scoreboard</h3>
            <div id="scoreboard-content">
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            </div>
        </div>
    </div>

    <!-- Live Tab -->
    <div id="tab-live" class="tab-content {{ 'active' if active_tab == 'live' else '' }}">
        <div class="page-header">
            <h1>Live Trading</h1>
            <div class="header-actions">
                <span id="live-status" class="badge">Connecting...</span>
            </div>
        </div>

        <div class="stats-row" id="live-stats">
            <div class="stat-card">
                <div class="label">Balance</div>
                <div class="value" id="live-balance">--</div>
            </div>
            <div class="stat-card">
                <div class="label">P&L</div>
                <div class="value" id="live-pnl">--</div>
            </div>
            <div class="stat-card">
                <div class="label">Win Rate</div>
                <div class="value" id="live-winrate">--</div>
            </div>
            <div class="stat-card">
                <div class="label">Positions</div>
                <div class="value" id="live-positions">--</div>
            </div>
            <div class="stat-card">
                <div class="label">Tradier</div>
                <div class="value" id="live-tradier">--</div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h3 style="margin: 0;">SPY Price & Trades</h3>
                    <span class="mono" style="color: var(--cyan);" id="live-chart-price">$---</span>
                    <span style="color: var(--text-muted);">|</span>
                    <span style="color: rgba(32, 150, 90, 0.8);">VIX</span>
                    <span class="mono" style="color: rgba(32, 150, 90, 0.8);" id="live-chart-vix">--</span>
                </div>
                <div style="display: flex; gap: 6px;">
                    <button class="btn live-hours active" data-hours="2">2H</button>
                    <button class="btn live-hours" data-hours="6">6H</button>
                    <button class="btn live-hours" data-hours="24">1D</button>
                    <button class="btn live-hours" data-hours="72">3D</button>
                    <button class="btn" id="live-reset-zoom" title="Reset zoom">↺</button>
                </div>
            </div>
            <div class="chart-container" style="height: 350px; cursor: grab;">
                <canvas id="live-chart"></canvas>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 15px; background: var(--bg-elevated); font-size: 11px; color: var(--text-dim); border-radius: 0 0 8px 8px;">
                <div style="display: flex; gap: 12px;">
                    <span><span style="display: inline-block; width: 8px; height: 8px; background: var(--green); border-radius: 50%;"></span> CALL</span>
                    <span><span style="display: inline-block; width: 8px; height: 8px; background: var(--red); border-radius: 50%;"></span> PUT</span>
                    <span><span style="display: inline-block; width: 8px; height: 8px; background: rgba(32, 150, 90, 0.7); border-radius: 50%;"></span> VIX</span>
                </div>
                <div><span id="live-chart-time">--</span></div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>Recent Trades</h3>
            <div id="live-trades">
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            </div>
        </div>
    </div>

    <!-- Training Tab -->
    <div id="tab-training" class="tab-content {{ 'active' if active_tab == 'training' else '' }}">
        <div class="page-header">
            <h1>Training Monitor</h1>
            <div class="header-actions">
                <button class="btn" onclick="refreshTraining()">Refresh</button>
            </div>
        </div>

        <div class="run-selector">
            <label>Active Run:</label>
            <select id="run-select" onchange="selectRun(this.value)">
                <option value="">Select a run...</option>
            </select>
            <span id="run-status" class="muted"></span>
        </div>

        <div class="stats-row" id="training-stats">
            <div class="stat-card">
                <div class="label">Cycles</div>
                <div class="value" id="training-cycles">--</div>
            </div>
            <div class="stat-card">
                <div class="label">P&L</div>
                <div class="value" id="training-pnl">--</div>
            </div>
            <div class="stat-card">
                <div class="label">Win Rate</div>
                <div class="value" id="training-winrate">--</div>
            </div>
            <div class="stat-card">
                <div class="label">Trades</div>
                <div class="value" id="training-trades">--</div>
            </div>
            <div class="stat-card">
                <div class="label">Signals</div>
                <div class="value" id="training-signals">--</div>
            </div>
            <div class="stat-card">
                <div class="label">Phase</div>
                <div class="value" id="training-phase">--</div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h3 style="margin: 0;">SPY Price & Trades</h3>
                    <span class="mono" style="color: var(--cyan);" id="training-chart-price">$---</span>
                    <span style="color: var(--text-muted);">|</span>
                    <span style="color: rgba(32, 150, 90, 0.8);">VIX</span>
                    <span class="mono" style="color: rgba(32, 150, 90, 0.8);" id="training-chart-vix">--</span>
                </div>
                <div style="display: flex; gap: 6px;">
                    <button class="btn training-hours active" data-hours="2">2H</button>
                    <button class="btn training-hours" data-hours="6">6H</button>
                    <button class="btn training-hours" data-hours="24">1D</button>
                    <button class="btn training-hours" data-hours="72">3D</button>
                    <button class="btn" id="training-reset-zoom" title="Reset zoom">↺</button>
                </div>
            </div>
            <div class="chart-container" style="height: 320px; cursor: grab;">
                <canvas id="training-chart"></canvas>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 15px; background: var(--bg-elevated); font-size: 11px; color: var(--text-dim); border-radius: 0 0 8px 8px;">
                <div style="display: flex; gap: 12px;">
                    <span><span style="display: inline-block; width: 8px; height: 8px; background: var(--green); border-radius: 50%;"></span> CALL</span>
                    <span><span style="display: inline-block; width: 8px; height: 8px; background: var(--red); border-radius: 50%;"></span> PUT</span>
                    <span><span style="display: inline-block; width: 8px; height: 8px; background: var(--cyan); border-radius: 50%;"></span> TCN</span>
                    <span><span style="display: inline-block; width: 8px; height: 8px; background: rgba(32, 150, 90, 0.7); border-radius: 50%;"></span> VIX</span>
                </div>
                <div>Cycle <span id="training-chart-cycle" style="color: var(--cyan);">0</span> • <span id="training-chart-time">--</span></div>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="tab-history" class="tab-content {{ 'active' if active_tab == 'history' else '' }}">
        <div class="page-header">
            <h1>Model History</h1>
            <div class="header-actions">
                <span id="model-count" class="muted"><span class="skeleton" style="display:inline-block;width:80px;height:14px;"></span></span>
            </div>
        </div>

        <div class="model-grid">
            <div class="model-sidebar" id="model-list">
                <div class="skeleton-card"><div class="skeleton skeleton-text medium"></div><div class="skeleton skeleton-text short"></div><div class="skeleton skeleton-text short"></div></div>
                <div class="skeleton-card"><div class="skeleton skeleton-text medium"></div><div class="skeleton skeleton-text short"></div><div class="skeleton skeleton-text short"></div></div>
                <div class="skeleton-card"><div class="skeleton skeleton-text medium"></div><div class="skeleton skeleton-text short"></div><div class="skeleton skeleton-text short"></div></div>
                <div class="skeleton-card"><div class="skeleton skeleton-text medium"></div><div class="skeleton skeleton-text short"></div><div class="skeleton skeleton-text short"></div></div>
            </div>
            <div class="model-detail" id="model-detail">
                <div class="empty-state">
                    <h3>Select a Model</h3>
                    <p>Choose a model from the list to view details</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Shared JS -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/components.js"></script>

    <script>
        // State
        let currentTab = '{{ active_tab }}';
        let selectedRun = null;
        let selectedModel = null;
        let liveChart = null;
        let trainingChart = null;
        let refreshIntervals = {};

        // Tab switching
        function switchTab(tab) {
            // Update URL without reload
            history.pushState({}, '', '/' + (tab === 'hub' ? '' : tab));

            // Update UI
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`.tab-btn:nth-child(${['hub', 'live', 'training', 'history'].indexOf(tab) + 1})`).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');

            currentTab = tab;

            // Load tab data
            if (tab === 'hub') loadHub();
            else if (tab === 'live') loadLive();
            else if (tab === 'training') loadTraining();
            else if (tab === 'history') loadHistory();
        }

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString();
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ==================== HUB ====================
        async function loadHub() {
            loadMachines();
            loadScoreboard();
        }

        async function loadMachines() {
            try {
                const resp = await fetch('/api/remote/machines');
                const data = await resp.json();

                const container = document.getElementById('machine-list');
                let html = `
                    <div class="machine-card active">
                        <strong>Local</strong><br>
                        <span class="muted">This machine</span>
                    </div>
                `;

                for (const m of data.machines || []) {
                    html += `
                        <div class="machine-card ${m.status}">
                            <strong>${m.hostname || m.machine_id}</strong><br>
                            <span class="muted">${m.runs?.length || 0} runs</span>
                        </div>
                    `;
                }

                container.innerHTML = html;
            } catch (e) {
                console.error('Error loading machines:', e);
            }
        }

        async function loadScoreboard() {
            try {
                const resp = await fetch('/api/scoreboard?limit=20&sort=pnl_pct&order=desc');
                const data = await resp.json();

                if (!data.experiments || data.experiments.length === 0) {
                    document.getElementById('scoreboard-content').innerHTML = '<div class="empty-state">No experiments yet</div>';
                    return;
                }

                let html = `
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Run ID</th>
                                <th>P&L %</th>
                                <th>Win Rate</th>
                                <th>Trades</th>
                                <th>Cycles</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const exp of data.experiments) {
                    const pnlClass = exp.pnl_pct >= 0 ? 'positive' : 'negative';
                    html += `
                        <tr>
                            <td>${exp.run_id || '-'}</td>
                            <td class="${pnlClass}">${exp.pnl_pct >= 0 ? '+' : ''}${(exp.pnl_pct || 0).toFixed(1)}%</td>
                            <td>${(exp.win_rate || 0).toFixed(1)}%</td>
                            <td>${exp.total_trades || 0}</td>
                            <td>${(exp.total_cycles || 0).toLocaleString()}</td>
                        </tr>
                    `;
                }

                html += '</tbody></table>';
                const scoreboardEl = document.getElementById('scoreboard-content');
                scoreboardEl.innerHTML = html;
                scoreboardEl.classList.add('fade-in');
            } catch (e) {
                document.getElementById('scoreboard-content').innerHTML = '<div class="error">Error loading scoreboard</div>';
            }
        }

        function refreshHub() {
            loadHub();
        }

        // ==================== LIVE ====================
        async function loadLive() {
            try {
                const resp = await fetch('/api/live/data');
                const data = await resp.json();

                document.getElementById('live-status').textContent = data.tradier_is_sandbox ? 'SANDBOX' : 'LIVE';
                document.getElementById('live-status').className = 'badge ' + (data.tradier_is_sandbox ? '' : 'live');

                document.getElementById('live-balance').textContent = fmt.currency(data.current_balance || 0);
                document.getElementById('live-pnl').textContent = fmt.currency(data.pnl || 0, true);
                document.getElementById('live-pnl').className = 'value ' + (data.pnl >= 0 ? 'positive' : 'negative');
                document.getElementById('live-winrate').textContent = fmt.pct(data.win_rate || 0);
                document.getElementById('live-positions').textContent = data.tradier_positions || 0;
                document.getElementById('live-tradier').textContent = fmt.currency(data.tradier_balance || 0);

                // Initialize and load chart
                if (!liveChart) initLiveChart();
                loadLiveChart();

                // Recent trades
                if (data.recent_trades && data.recent_trades.length > 0) {
                    document.getElementById('live-trades').innerHTML = renderTradesTable(
                        data.recent_trades.slice(0, 10),
                        { emptyMessage: 'No trades yet' }
                    );
                } else {
                    document.getElementById('live-trades').innerHTML = '<div class="empty-state">No trades yet</div>';
                }
            } catch (e) {
                console.error('Error loading live data:', e);
                document.getElementById('live-status').textContent = 'OFFLINE';
            }
        }

        let liveChartHours = 2;
        let liveChartData = null;

        function initLiveChart() {
            const ctx = document.getElementById('live-chart').getContext('2d');
            if (liveChart) liveChart.destroy();

            liveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'SPY',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0
                        },
                        {
                            label: 'VIX',
                            data: [],
                            borderColor: 'rgba(32, 150, 90, 0.7)',
                            backgroundColor: 'rgba(32, 150, 90, 0.05)',
                            borderWidth: 1.8,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(18, 18, 26, 0.95)',
                            titleColor: '#f0f0f5',
                            bodyColor: '#8888a0',
                            borderColor: '#2a2a3a',
                            borderWidth: 1
                        },
                        annotation: { annotations: {} },
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'MM/dd' } },
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: { color: '#555566', maxTicksLimit: 8 }
                        },
                        y: {
                            position: 'left',
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: { color: '#555566', callback: v => '$' + v.toFixed(0) }
                        },
                        y2: {
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: 'rgba(32, 150, 90, 0.6)', callback: v => v.toFixed(1) },
                            title: { display: true, text: 'VIX', color: 'rgba(32, 150, 90, 0.7)', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        async function loadLiveChart() {
            try {
                const resp = await fetch('/api/live/chart');
                if (!resp.ok) return;
                liveChartData = await resp.json();
                updateLiveChart();
            } catch (e) {
                console.error('Error loading live chart:', e);
            }
        }

        function updateLiveChart() {
            if (!liveChart || !liveChartData?.spy_prices?.length) return;

            const now = liveChartData.simulated_time
                ? parseLocalTime(liveChartData.simulated_time)
                : new Date();

            const cutoff = new Date(now.getTime() - liveChartHours * 60 * 60 * 1000);

            // SPY prices - handle both array and object format
            const prices = liveChartData.spy_prices
                .filter(p => {
                    const ts = Array.isArray(p) ? p[0] : p.timestamp;
                    const t = parseLocalTime(ts);
                    return t >= cutoff && t <= now;
                })
                .map(p => {
                    if (Array.isArray(p)) {
                        return { x: parseLocalTime(p[0]), y: p[1] };
                    } else {
                        return { x: parseLocalTime(p.timestamp), y: p.close };
                    }
                });

            liveChart.data.datasets[0].data = prices;

            // VIX prices if available
            if (liveChartData.vix_prices?.length) {
                const vixData = liveChartData.vix_prices
                    .filter(p => {
                        const t = parseLocalTime(p.timestamp);
                        return t >= cutoff && t <= now;
                    })
                    .map(p => ({ x: parseLocalTime(p.timestamp), y: p.close }));
                liveChart.data.datasets[1].data = vixData;
            }

            // Trade annotations
            const annotations = {};

            // NOW marker
            if (prices.length > 0) {
                annotations.now = {
                    type: 'line',
                    xMin: now, xMax: now,
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: { display: true, content: 'NOW', position: 'start', backgroundColor: '#3b82f6', color: '#fff', font: { size: 9 }, padding: 3 }
                };
            }

            // Trade entry/exit markers from annotations
            let idx = 0;
            if (liveChartData.annotations) {
                for (const a of liveChartData.annotations) {
                    const t = parseLocalTime(a.timestamp);
                    if (t < cutoff || t > now) continue;

                    const price = findNearestPriceLive(a.timestamp);
                    if (!price) continue;

                    const isEntry = a.type === 'entry';
                    const isCall = a.option_type === 'CALL';
                    const color = isCall ? '#00d68f' : '#ff5c7c';

                    if (isEntry) {
                        annotations[`e${idx}`] = {
                            type: 'point',
                            xValue: t,
                            yValue: price,
                            backgroundColor: color,
                            borderColor: '#fff',
                            borderWidth: 2,
                            radius: 5
                        };
                    } else {
                        const pnlColor = (a.pnl || 0) > 0 ? '#00d68f' : '#ff5c7c';
                        annotations[`x${idx}`] = {
                            type: 'point',
                            xValue: t,
                            yValue: price,
                            backgroundColor: pnlColor,
                            borderColor: '#fff',
                            borderWidth: 2,
                            radius: 4
                        };
                    }
                    idx++;
                }
            }

            liveChart.options.plugins.annotation.annotations = annotations;
            liveChart.update('none');

            // Update header stats
            const lastPrice = prices.length > 0 ? prices[prices.length - 1].y : 0;
            document.getElementById('live-chart-price').textContent = lastPrice > 0 ? '$' + lastPrice.toFixed(2) : '$---';
            document.getElementById('live-chart-time').textContent = now.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            if (liveChartData.vix_prices?.length) {
                const latestVix = liveChartData.vix_prices[liveChartData.vix_prices.length - 1].close;
                document.getElementById('live-chart-vix').textContent = latestVix.toFixed(2);
            }
        }

        function findNearestPriceLive(ts) {
            if (!liveChartData?.spy_prices?.length) return null;
            const target = parseLocalTime(ts).getTime();
            let nearest = liveChartData.spy_prices[0];
            let nearestTs = Array.isArray(nearest) ? nearest[0] : nearest.timestamp;
            let minDiff = Math.abs(parseLocalTime(nearestTs).getTime() - target);
            for (const p of liveChartData.spy_prices) {
                const pTs = Array.isArray(p) ? p[0] : p.timestamp;
                const diff = Math.abs(parseLocalTime(pTs).getTime() - target);
                if (diff < minDiff) { minDiff = diff; nearest = p; }
            }
            return Array.isArray(nearest) ? nearest[1] : nearest.close;
        }

        // Live chart controls
        document.querySelectorAll('.live-hours').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.live-hours').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                liveChartHours = parseInt(this.dataset.hours);
                updateLiveChart();
                liveChart?.resetZoom();
            });
        });

        document.getElementById('live-reset-zoom')?.addEventListener('click', () => liveChart?.resetZoom());

        // ==================== TRAINING ====================
        async function loadTraining() {
            // Load runs list
            try {
                const resp = await fetch('/api/training/runs');
                const data = await resp.json();

                const select = document.getElementById('run-select');
                select.innerHTML = '<option value="">Select a run...</option>';

                const activeCount = data.active_count || 0;
                document.getElementById('active-runs-badge').textContent = activeCount;

                for (const run of data.runs || []) {
                    const opt = document.createElement('option');
                    opt.value = run.log_file;
                    opt.textContent = `${run.run_name} ${run.is_active ? '(ACTIVE)' : ''} - ${run.size_mb}MB`;
                    if (run.source !== 'local') opt.textContent += ` [${run.source}]`;
                    select.appendChild(opt);
                }

                // Auto-select first active run
                const activeRun = data.runs?.find(r => r.is_active);
                if (activeRun) {
                    select.value = activeRun.log_file;
                    selectRun(activeRun.log_file);
                }
            } catch (e) {
                console.error('Error loading training runs:', e);
            }
        }

        async function selectRun(logFile) {
            selectedRun = logFile;
            if (!logFile) return;

            try {
                const resp = await fetch(`/api/training/data?log_file=${encodeURIComponent(logFile)}`);
                const data = await resp.json();

                document.getElementById('training-cycles').textContent = (data.cycles || 0).toLocaleString();
                document.getElementById('training-pnl').textContent = fmt.currency(data.pnl || 0, true);
                document.getElementById('training-pnl').className = 'value ' + (data.pnl >= 0 ? 'positive' : 'negative');
                document.getElementById('training-winrate').textContent = fmt.pct(data.win_rate || 0);
                document.getElementById('training-trades').textContent = data.trades || 0;
                document.getElementById('training-signals').textContent = data.signals || 0;
                document.getElementById('training-phase').textContent = data.phase || '--';

                document.getElementById('run-status').textContent = `Last update: ${data.last_update || '--'}`;

                // Initialize and load the SPY price chart
                initTrainingChart();
                loadTrainingChartData();
            } catch (e) {
                console.error('Error loading training data:', e);
            }
        }

        let trainingChartHours = 2;
        let trainingChartData = null;

        function initTrainingChart() {
            const ctx = document.getElementById('training-chart').getContext('2d');
            if (trainingChart) trainingChart.destroy();

            trainingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'SPY',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0
                        },
                        {
                            label: 'TCN Future',
                            data: [],
                            borderColor: 'rgba(0, 200, 255, 0.8)',
                            borderWidth: 2.5,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        },
                        {
                            label: 'VIX',
                            data: [],
                            borderColor: 'rgba(32, 150, 90, 0.7)',
                            backgroundColor: 'rgba(32, 150, 90, 0.05)',
                            borderWidth: 1.8,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(18, 18, 26, 0.95)',
                            titleColor: '#f0f0f5',
                            bodyColor: '#8888a0',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            filter: (item) => item.datasetIndex < 3
                        },
                        annotation: { annotations: {} },
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'MM/dd' } },
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: { color: '#555566', maxTicksLimit: 8 }
                        },
                        y: {
                            position: 'left',
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: { color: '#555566', callback: v => '$' + v.toFixed(0) }
                        },
                        y2: {
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: 'rgba(32, 150, 90, 0.6)', callback: v => v.toFixed(1) },
                            title: { display: true, text: 'VIX', color: 'rgba(32, 150, 90, 0.7)', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        async function loadTrainingChartData() {
            try {
                const resp = await fetch('/api/training/chart');
                if (!resp.ok) return;
                trainingChartData = await resp.json();
                updateTrainingChart();
            } catch (e) {
                console.error('Training chart error:', e);
            }
        }

        function parseLocalTime(ts) {
            if (!ts) return new Date();
            return new Date(ts.replace('T', ' '));
        }

        function updateTrainingChart() {
            if (!trainingChart || !trainingChartData?.spy_prices?.length) return;

            const now = trainingChartData.simulated_time
                ? parseLocalTime(trainingChartData.simulated_time)
                : parseLocalTime(trainingChartData.spy_prices[trainingChartData.spy_prices.length - 1].timestamp);

            const cutoff = new Date(now.getTime() - trainingChartHours * 60 * 60 * 1000);

            // SPY prices
            const prices = trainingChartData.spy_prices
                .filter(p => {
                    const t = parseLocalTime(p.timestamp);
                    return t >= cutoff && t <= now;
                })
                .map(p => ({ x: parseLocalTime(p.timestamp), y: p.close }));

            trainingChart.data.datasets[0].data = prices;

            // VIX prices
            if (trainingChartData.vix_prices?.length) {
                const vixData = trainingChartData.vix_prices
                    .filter(p => {
                        const t = parseLocalTime(p.timestamp);
                        return t >= cutoff && t <= now;
                    })
                    .map(p => ({ x: parseLocalTime(p.timestamp), y: p.close }));
                trainingChart.data.datasets[2].data = vixData;
            }

            // Trade annotations
            const annotations = {};
            if (trainingChartData.simulated_time && prices.length > 0) {
                annotations.now = {
                    type: 'line',
                    xMin: now, xMax: now,
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: { display: true, content: 'NOW', position: 'start', backgroundColor: '#3b82f6', color: '#fff', font: { size: 9 }, padding: 3 }
                };
            }

            let idx = 0;
            if (trainingChartData.trades) {
                for (const trade of trainingChartData.trades) {
                    const entryTime = parseLocalTime(trade.entry_time);
                    if (entryTime < cutoff || entryTime > now) continue;

                    const price = findNearestPriceTraining(trade.entry_time);
                    if (!price) continue;

                    const isCall = trade.type?.includes('CALL');
                    const color = isCall ? '#00d68f' : '#ff5c7c';

                    annotations[`e${idx}`] = {
                        type: 'point',
                        xValue: entryTime,
                        yValue: price,
                        backgroundColor: color,
                        borderColor: '#fff',
                        borderWidth: 2,
                        radius: 5
                    };

                    if (trade.exit_time && trade.status !== 'OPEN') {
                        const exitTime = parseLocalTime(trade.exit_time);
                        if (exitTime >= cutoff && exitTime <= now) {
                            const exitPrice = findNearestPriceTraining(trade.exit_time);
                            if (exitPrice) {
                                const pnlColor = trade.pnl > 0 ? '#00d68f' : '#ff5c7c';
                                annotations[`x${idx}`] = {
                                    type: 'point',
                                    xValue: exitTime,
                                    yValue: exitPrice,
                                    backgroundColor: pnlColor,
                                    borderColor: '#fff',
                                    borderWidth: 2,
                                    radius: 4
                                };
                                annotations[`l${idx}`] = {
                                    type: 'line',
                                    xMin: entryTime, xMax: exitTime,
                                    yMin: price, yMax: exitPrice,
                                    borderColor: pnlColor,
                                    borderWidth: 1.5
                                };
                            }
                        }
                    }
                    idx++;
                }
            }

            trainingChart.options.plugins.annotation.annotations = annotations;
            trainingChart.update('none');

            // Update header stats
            document.getElementById('training-chart-cycle').textContent = trainingChartData.cycles || 0;
            document.getElementById('training-chart-time').textContent = trainingChartData.simulated_time
                ? parseLocalTime(trainingChartData.simulated_time).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                : '--';
            document.getElementById('training-chart-price').textContent = trainingChartData.current_price > 0
                ? '$' + trainingChartData.current_price.toFixed(2) : '$---';

            if (trainingChartData.vix_prices?.length) {
                const latestVix = trainingChartData.vix_prices[trainingChartData.vix_prices.length - 1].close;
                document.getElementById('training-chart-vix').textContent = latestVix.toFixed(2);
            }
        }

        function findNearestPriceTraining(ts) {
            if (!trainingChartData?.spy_prices?.length) return null;
            const target = parseLocalTime(ts).getTime();
            let nearest = trainingChartData.spy_prices[0];
            let minDiff = Math.abs(parseLocalTime(nearest.timestamp).getTime() - target);
            for (const p of trainingChartData.spy_prices) {
                const diff = Math.abs(parseLocalTime(p.timestamp).getTime() - target);
                if (diff < minDiff) { minDiff = diff; nearest = p; }
            }
            return nearest.close;
        }

        // Training chart controls
        document.querySelectorAll('.training-hours').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.training-hours').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                trainingChartHours = parseInt(this.dataset.hours);
                updateTrainingChart();
                trainingChart?.resetZoom();
            });
        });

        document.getElementById('training-reset-zoom')?.addEventListener('click', () => trainingChart?.resetZoom());

        function refreshTraining() {
            loadTraining();
            if (selectedRun) {
                selectRun(selectedRun);
                loadTrainingChartData();
            }
        }

        // ==================== HISTORY ====================
        async function loadHistory() {
            try {
                const resp = await fetch('/api/history/models');
                const data = await resp.json();

                document.getElementById('model-count').textContent = `${data.count} models`;

                const container = document.getElementById('model-list');

                if (!data.models || data.models.length === 0) {
                    container.innerHTML = '<div class="empty-state">No models found</div>';
                    return;
                }

                container.innerHTML = data.models.map(m => `
                    <div class="model-item" onclick="selectModel('${m.run_id}')">
                        <div class="model-name">${m.run_id}</div>
                        <div class="model-stats">
                            <div><span class="muted">P&L</span><span class="${m.pnl >= 0 ? 'positive' : 'negative'}">${m.pnl >= 0 ? '+' : ''}${m.pnl_pct.toFixed(1)}%</span></div>
                            <div><span class="muted">Win</span><span>${m.win_rate.toFixed(1)}%</span></div>
                            <div><span class="muted">Trades</span><span>${m.total_trades}</span></div>
                            <div><span class="muted">Cycles</span><span>${m.total_cycles.toLocaleString()}</span></div>
                        </div>
                    </div>
                `).join('');
                container.classList.add('fade-in');
            } catch (e) {
                console.error('Error loading history:', e);
            }
        }

        async function selectModel(runId) {
            selectedModel = runId;

            // Update selection UI
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // Show loading skeleton in detail panel
            document.getElementById('model-detail').innerHTML = `
                <div class="skeleton skeleton-text medium" style="height:24px;margin-bottom:15px;"></div>
                <div class="skeleton skeleton-text short" style="margin-bottom:20px;"></div>
                <div class="stats-row" style="margin: 20px 0;">
                    <div class="stat-card"><div class="skeleton skeleton-stat"></div></div>
                    <div class="stat-card"><div class="skeleton skeleton-stat"></div></div>
                    <div class="stat-card"><div class="skeleton skeleton-stat"></div></div>
                    <div class="stat-card"><div class="skeleton skeleton-stat"></div></div>
                </div>
                <div class="skeleton skeleton-text short" style="height:20px;margin:20px 0;"></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            `;

            try {
                const [modelResp, tradesResp] = await Promise.all([
                    fetch(`/api/history/model/${runId}`),
                    fetch(`/api/history/model/${runId}/trades`)
                ]);

                const model = await modelResp.json();
                const tradesData = await tradesResp.json();

                if (model.error) {
                    document.getElementById('model-detail').innerHTML = `<div class="error">${model.error}</div>`;
                    return;
                }

                const pnlClass = model.pnl >= 0 ? 'positive' : 'negative';

                const detailEl = document.getElementById('model-detail');
                detailEl.innerHTML = `
                    <h2>${model.run_id}</h2>
                    <p class="muted">Timestamp: ${model.timestamp || 'Unknown'}</p>

                    <div class="stats-row" style="margin: 20px 0;">
                        <div class="stat-card">
                            <div class="label">P&L</div>
                            <div class="value ${pnlClass}">${model.pnl >= 0 ? '+' : ''}$${Math.abs(model.pnl).toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Return</div>
                            <div class="value ${pnlClass}">${model.pnl_pct >= 0 ? '+' : ''}${model.pnl_pct.toFixed(2)}%</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Win Rate</div>
                            <div class="value">${model.win_rate.toFixed(1)}%</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Trades</div>
                            <div class="value">${model.total_trades}</div>
                        </div>
                    </div>

                    <h3>P&L Curve</h3>
                    <div class="chart-container" style="height: 250px; margin-bottom: 20px;">
                        <canvas id="history-chart"></canvas>
                    </div>

                    <h3>Trade History (${tradesData.trade_count || 0}${tradesData.has_more ? ` of ${tradesData.total_count.toLocaleString()}` : ''} trades)${tradesData.has_more ? ' <span style="color:var(--gold);font-size:0.8rem;">(showing most recent)</span>' : ''}</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${renderTradesTable(tradesData.trades || [], { emptyMessage: 'No trades' })}
                    </div>
                `;
                detailEl.classList.add('fade-in');

                // Render P&L chart
                renderHistoryChart(tradesData.trades || []);
            } catch (e) {
                document.getElementById('model-detail').innerHTML = `<div class="error">Error loading model</div>`;
            }
        }

        let historyChart = null;

        function renderHistoryChart(trades) {
            if (!trades || trades.length === 0) return;

            // Reverse trades to chronological order (API returns newest first)
            const chronoTrades = [...trades].reverse();

            // Build cumulative P&L data
            let cumPnl = 0;
            const pnlData = chronoTrades.map((t, i) => {
                const pnl = parseFloat(t.pnl) || 0;
                cumPnl += pnl;
                return {
                    x: i + 1,
                    y: cumPnl,
                    pnl: pnl,
                    type: t.option_type || t.type
                };
            });

            // Add starting point
            pnlData.unshift({ x: 0, y: 0 });

            const canvas = document.getElementById('history-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (historyChart) historyChart.destroy();

            // Color based on final P&L
            const finalPnl = pnlData[pnlData.length - 1].y;
            const lineColor = finalPnl >= 0 ? 'rgb(0, 214, 143)' : 'rgb(255, 92, 124)';
            const fillColor = finalPnl >= 0 ? 'rgba(0, 214, 143, 0.1)' : 'rgba(255, 92, 124, 0.1)';

            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: pnlData,
                        borderColor: lineColor,
                        backgroundColor: fillColor,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const point = pnlData[ctx.dataIndex];
                                    if (point.pnl !== undefined) {
                                        return `P&L: $${point.y.toFixed(2)} (Trade: ${point.pnl >= 0 ? '+' : ''}$${point.pnl.toFixed(2)})`;
                                    }
                                    return `P&L: $${point.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Trade #', color: '#888' },
                            grid: { color: '#2a2a3a' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            title: { display: true, text: 'Cumulative P&L ($)', color: '#888' },
                            grid: { color: '#2a2a3a' },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial tab
            if (currentTab === 'hub') loadHub();
            else if (currentTab === 'live') loadLive();
            else if (currentTab === 'training') loadTraining();
            else if (currentTab === 'history') loadHistory();

            // Auto-refresh live and training tabs
            setInterval(() => {
                if (currentTab === 'live') loadLive();
                if (currentTab === 'training' && selectedRun) selectRun(selectedRun);
            }, 5000);

            // Refresh machines periodically
            setInterval(loadMachines, 30000);
        });
    </script>
</body>
</html>
